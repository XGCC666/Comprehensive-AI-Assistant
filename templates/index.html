<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åŠ©æ‰‹ (æ€¥æ•‘ç‰ˆ)</title>
    <style>
        /* ============ åŸºç¡€é‡ç½® ============ */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: #343541; /* æ·±è‰²èƒŒæ™¯ */
            color: #ececf1;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ============ ä¾§è¾¹æ  ============ */
        .sidebar {
            width: 260px;
            background-color: #202123;
            border-right: 1px solid #4d4d4f;
            display: flex;
            flex-direction: column;
            padding: 10px;
            flex-shrink: 0;
        }

        .btn-new {
            border: 1px solid #565869;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            background: transparent;
            margin-bottom: 20px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-new:hover { background-color: #2a2b32; }

        .history-list {
            flex: 1;
            overflow-y: auto;
        }
        .history-item {
            padding: 10px;
            cursor: pointer;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-item:hover { background-color: #2a2b32; color: white; }

        /* ============ ä¸»çª—å£ ============ */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #343541;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 120px; /* ç»™åº•éƒ¨ç•™ç©ºé—´ */
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .message.user { background-color: #343541; border: 1px solid #565869; }
        .message.assistant { background-color: #444654; }
        
        .msg-content { display: flex; gap: 15px; max-width: 800px; margin: 0 auto; }
        .avatar { 
            width: 30px; height: 30px; background: #19c37d; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 4px; flex-shrink: 0;
        }
        .user .avatar { background: #5436da; }

        /* ============ è¾“å…¥æ¡† (ç»å¯¹å®šä½) ============ */
        .input-area {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 30px;
            background: linear-gradient(180deg, transparent, #343541 20%);
            display: flex;
            justify-content: center;
        }
        .input-box {
            width: 100%; max-width: 800px;
            background: #40414f;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        textarea {
            flex: 1;
            background: transparent; border: none; color: white;
            resize: none; height: 24px; outline: none; font-size: 16px;
        }
        .btn-send {
            background: transparent; border: none; color: #ccc;
            cursor: pointer; font-size: 20px; padding: 0 10px;
        }
        .btn-send:hover { color: white; }

        /* ============ å¼¹çª— ============ */
        #modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none; /* é»˜è®¤éšè— */
            align-items: center; justify-content: center;
            z-index: 100;
        }
        .modal-box {
            background: #202123; padding: 30px; border-radius: 10px;
            text-align: center; width: 300px; border: 1px solid #565869;
        }
        select { width: 100%; padding: 10px; margin: 20px 0; background: #40414f; color: white; border: none; }
        button { padding: 10px 20px; cursor: pointer; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="btn-new" onclick="openModal()">+ æ–°å¯¹è¯</div>
        <div class="history-list" id="history-list">
            <div style="padding:10px; color:#666;">æ­£åœ¨åŠ è½½å†å²...</div>
        </div>
        <div style="margin-top:auto; padding-top:10px; border-top:1px solid #444;">
            <div style="padding:10px; color:#aaa; cursor:pointer;">âš™ï¸ è®¾ç½®</div>
        </div>
    </div>

    <div class="main-chat">
        <div class="chat-container" id="chat-box">
            <div style="text-align:center; color:#666; margin-top:50px;">
                <h2>My AI Assistant</h2>
                <p>è¯·ç‚¹å‡»å·¦ä¾§â€œæ–°å¯¹è¯â€æˆ–é€‰æ‹©å†å²è®°å½•</p>
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="inp" placeholder="å‘é€æ¶ˆæ¯..." rows="1"></textarea>
                <button class="btn-send" onclick="sendMsg()">â¤</button>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-box">
            <h3>é€‰æ‹©åŠ©æ‰‹</h3>
            <select id="sel"></select>
            <button onclick="startChat()" style="background:#19c37d; border:none; color:white; border-radius:5px;">å¼€å§‹</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="background:transparent; border:none; color:#aaa;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const inp = document.getElementById('inp');

        // åˆå§‹åŒ–
        window.onload = async () => {
            try {
                // åŠ è½½è§’è‰²
                const r1 = await fetch('/api/prompts');
                const prompts = await r1.json();
                document.getElementById('sel').innerHTML = prompts.map(p => `<option>${p}</option>`).join('');

                // åŠ è½½å†å²
                loadHistory();
            } catch(e) {
                alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ python app.py æ˜¯å¦åœ¨è¿è¡Œï¼");
            }
        };

        async function loadHistory() {
            const r2 = await fetch('/api/history');
            const chats = await r2.json();
            const list = document.getElementById('history-list');
            if(chats.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#666;">æš‚æ— å†å²</div>';
                return;
            }
            list.innerHTML = chats.map(c => `
                <div class="history-item" onclick="loadOld('${c.id}')">
                    ğŸ’¬ ${c.title}
                </div>
            `).join('');
        }

        function openModal() { document.getElementById('modal').style.display = 'flex'; }

        async function startChat() {
            const name = document.getElementById('sel').value;
            const res = await fetch('/api/new_chat', {
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({filename: name})
            });
            const data = await res.json();
            document.getElementById('modal').style.display = 'none';
            chatBox.innerHTML = '';
            addMsg('assistant', data.greeting);
            loadHistory();
        }

        async function loadOld(id) {
            const res = await fetch('/api/load_chat', {
                method:'POST', 
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({chat_id: id})
            });
            const data = await res.json();
            chatBox.innerHTML = '';
            data.messages.slice(1).forEach(m => addMsg(m.role, m.content));
        }

        async function sendMsg() {
            const txt = inp.value.trim();
            if(!txt) return;
            addMsg('user', txt);
            inp.value = '';

            const aiDiv = addMsg('assistant', '...');
            
            const src = new EventSource(`/api/chat_stream?message=${encodeURIComponent(txt)}`);
            let fullText = "";
            src.onmessage = (e) => {
                if(fullText === "") aiDiv.innerText = ""; // æ¸…ç©º...
                fullText += e.data;
                aiDiv.innerText = fullText;
                chatBox.scrollTop = chatBox.scrollHeight;
            };
            src.onerror = () => { src.close(); loadHistory(); };
        }

        function addMsg(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `
                <div class="msg-content">
                    <div class="avatar">${role==='user'?'U':'AI'}</div>
                    <div style="padding-top:4px;">${text}</div>
                </div>
            `;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return div.querySelector('.msg-content div:last-child');
        }

        // å›è½¦å‘é€
        inp.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); sendMsg();
            }
        });
    </script>
</body>
</html>